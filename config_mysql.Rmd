---
title: "DBMS 환경 설정"
description: |
   **ecoDI 패키지와 ecoDI Manager**가 동작할 **MySQL 서버**에 환경설정하는 방법을 살펴봅니다.
author:
  - name: 유충현 
    url: https://choonghyunryu.github.io/
    affiliation: 디플래닉스 DS
    affiliation_url: https://www.dplanex.com/
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      collapse = FALSE,
                      fig.align = "center",
                      tidy.opts = list(width.cutoff = 70), 
                      tidy = TRUE)
knitr::opts_chunk$set(fig.width = 12, fig.height = 9)

library(shiny, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)

xaringanExtra :: use_panelset()
```


```{r}
#| intro, 
#| echo=FALSE, 
#| out.width = "45%"
knitr::include_graphics("img/config_dbms.png")
```


```{r, preface, echo=FALSE}
div(class = "preface", 
    h4("들어가기"),
    "DBMS 설치로 기초 준비는 되었지만, 사용 환경을 설정해야 합니다.", br(),
    strong("사용자 계정을 생성하고 DB 스키마를 생성"), "합니다.", br(), 
    "그리고 ", strong("ecoDI 메타 테이블을 생성하고, 초기 데이터를 마이그레이션"), "해야 기초 설정이 마무리됩니다.")
```

<br>


## MySQL 사용자 환경 설정하기

Amazon Linux 2023의 패키지 관리자는 `dnf`입니다. `dnf`를 이용하여 MySQL Server를 설치합니다.

### MySQL 접속하기

**root 계정**으로 mysql 명령어로 MySQL 서버에 접속합니다. 이때, **`--local-infile=1` 옵션을 설정하여, 로컬 파일 임포트를 허용합니다.**

```{bash, eval=FALSE}
mysql -u root -p --local-infile=1
```


### 사용자 생성하기

`create user` 명령어로 `ecodi` 사용자를 생성합니다. 패스워드는 보안상 에스터리스크(*)로 표현하였습니다.

```{bash, eval=FALSE}
create user 'ecodi'@'localhost' identified by '*******';
grant all privileges on *.* to 'ecodi'@'localhost';
FLUSH PRIVILEGES;
```


### DB 스키마 생성하기

`ecodi_meta`, `ecodi_ods`, `ecodi_data` 3개의 DB 스키마를 생성합니다. 각 스키마의 문자셋은 `utf8mb3`, 콜레이션은 `utf8mb3_general_ci`로 설정합니다.

```{bash, eval=FALSE}
CREATE SCHEMA ecodi_meta DEFAULT CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci;
CREATE SCHEMA ecodi_ods DEFAULT CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci;
CREATE SCHEMA ecodi_data DEFAULT CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci;
```

<br>

3개의 DB 스키마의 역할은 다음과 같습니다.


```{r schema, echo=FALSE, fig.cap='ecoDI의 DB 스키마 구성', out.width = "80%"}
knitr::include_graphics("img/schema.png")
```


## 사전 준비하기

ecoDI 패키지와 ecoDI Manager가 동작하기 위해서는 메타 테이블과 초기 데이터가 필요합니다. 

기존에는 개인 Macbook 장비에서 개발하였고, 과정에서 DBMS 테이블에 집적한 데이터를 이식 환경에 마이그레이션해야 합니다.

마이그레이션할 테이블을 export하여 파일로 준비하는 작업을 다음과 같이 수행하였습니다.

### 메타 테이블 export

```{bash, eval=FALSE}
# export tables using mysqldump
mkdir ~/sql_migration
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_indctr > ~/sql_migration/mt_kosis_indctr.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_indexpl > ~/sql_migration/mt_kosis_indexpl.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_indlist > ~/sql_migration/mt_kosis_indlist.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_itm > ~/sql_migration/mt_kosis_itm.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_org > ~/sql_migration/mt_kosis_org.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_prd > ~/sql_migration/mt_kosis_prd.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_prdse > ~/sql_migration/mt_kosis_prdse.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_src > ~/sql_migration/mt_kosis_src.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_stat > ~/sql_migration/mt_kosis_stat.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_statexpl > ~/sql_migration/mt_kosis_statexpl.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_kosis_tbl > ~/sql_migration/mt_kosis_tbl.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_log_dataimp > ~/sql_migration/mt_log_dataimp.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_log_manage > ~/sql_migration/mt_log_manage.sql
mysqldump -h localhost -uroot -p ecodi_meta mt_schema_list > ~/sql_migration/mt_schema_list.sql
```

export된 파일의 용량이 제법 큽니다. 다음은 각 SQL 파일의 용량을 확인한 결과입니다.

```bash
(base) choonghyunryu@yuchunghyeon-ui-MacBookPro sql_migration % du -h *.sql    
236K	mt_kosis_indctr.sql
440K	mt_kosis_indexpl.sql
 12K	mt_kosis_indlist.sql
2.8G	mt_kosis_itm.sql
116K	mt_kosis_org.sql
 23M	mt_kosis_prd.sql
4.0K	mt_kosis_prdse.sql
 47M	mt_kosis_src.sql
 80M	mt_kosis_stat.sql
4.9M	mt_kosis_statexpl.sql
 32M	mt_kosis_tbl.sql
292M	mt_log_dataimp.sql
881M	mt_log_manage.sql
4.0K	mt_schema_list.sql
(base) choonghyunryu@yuchunghyeon-ui-MacBookPro sql_migration % 
```

이 파일들을 크롤링 서버로 전송해야 합니다. 하지만 파일 용량이 너무 커서 다음 스크립트 compress.sh로 압축을 합니다.

압축 효율이 높은 xz로 압축하며, 압축 레벨도 9로 최대로 설정합니다.

```bash
(base) choonghyunryu@yuchunghyeon-ui-MacBookPro sql_migration % cat compress.sh
#!/bin/bash

flist=`ls *.sql`

for fname in $flist; do
  tar -cvf "${fname}.tar" "$fname" 
  xz -9 "${fname}.tar" 
  echo "Compressed {$fname}"
done

(base) choonghyunryu@yuchunghyeon-ui-MacBookPro sql_migration % 
```

압축된 파일들의 용량은 다음과 같습니다.

```bash
(base) choonghyunryu@yuchunghyeon-ui-MacBookPro ecoDI_meta % du -h *.xz
 24K	mt_kosis_indctr.sql.tar.xz
 28K	mt_kosis_indexpl.sql.tar.xz
4.0K	mt_kosis_indlist.sql.tar.xz
 80M	mt_kosis_itm.sql.tar.xz
 20K	mt_kosis_org.sql.tar.xz
512K	mt_kosis_prd.sql.tar.xz
4.0K	mt_kosis_prdse.sql.tar.xz
768K	mt_kosis_src.sql.tar.xz
3.1M	mt_kosis_stat.sql.tar.xz
960K	mt_kosis_statexpl.sql.tar.xz
3.1M	mt_kosis_tbl.sql.tar.xz
8.1M	mt_log_dataimp.sql.tar.xz
 34M	mt_log_manage.sql.tar.xz
4.0K	mt_schema_list.sql.tar.xz
(base) choonghyunryu@yuchunghyeon-ui-MacBookPro ecoDI_meta % 
```

### export 파일 전송

export된 파일을 github 저장소에 올려 놓았습니다. 리소스의 백업과 버전 관리를 위해서입니다. 

다음 저장소에서 다운로드할 수 있습니다.

- https://github.com/choonghyunryu/ecoDI_meta.git

크롤링 서버에서 git 클론(clone)으로 다운로드합니다.

```bash
git clone https://github.com/choonghyunryu/ecoDI_meta.git
```

### 파일 압축 풀기

다운로드한 `ecoDI_meta` 디렉토리로 이동하여, 다음 스크립트로 압축을 풉니다.

```bash
#!/bin/bash
flist=`ls *.tar.xz`
for fname in $flist; do
  xz -d "$fname"
  tar -xvf "${fname%.xz}"
  echo "Decompressed {$fname}"
done
```

### 마이그레이션 import

압축을 푼 SQL 파일을 다음 스크립트로 마이그레이션합니다.

```bash
# import dump file
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_indctr.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_indexpl.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_indlist.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_itm.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_org.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_prd.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_prdse.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_src.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_stat.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_statexpl.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_kosis_tbl.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_log_dataimp.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_log_manage.sql
mysql -h localhost -uecodi -p ecodi_meta < mt_schema_list.sql
```





